name: ðŸš€ Build and Release OfficeLog

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version tag (e.g., v1.0.1)"
                required: true
                default: "v1.0.1"
            prerelease:
                description: "Mark as pre-release"
                required: false
                default: false
                type: boolean

jobs:
    build-and-release:
        name: ðŸ“± Build APK & Create Release
        runs-on: ubuntu-latest
        timeout-minutes: 45

        steps:
            - name: ðŸ“¥ Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ðŸ·ï¸ Determine Release Version (pre)
              id: version_info
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION="${GITHUB_REF#refs/tags/}"
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT
                  echo "Release version (pre): $VERSION"

            - name: ðŸ§¾ Read pubspec version
              id: pubspec_version
              run: |
                  PUBSPEC_VERSION_LINE=$(grep -E '^version:' pubspec.yaml)
                  PUBSPEC_VERSION=$(echo "$PUBSPEC_VERSION_LINE" | awk '{print $2}')
                  # Remove any build number (+X) if present for semantic version comparison
                  PUBSPEC_VERSION_NUMBER="${PUBSPEC_VERSION%%+*}"
                  echo "PUBSPEC_VERSION=$PUBSPEC_VERSION" >> $GITHUB_OUTPUT
                  echo "PUBSPEC_VERSION_NUMBER=$PUBSPEC_VERSION_NUMBER" >> $GITHUB_OUTPUT
                  echo "pubspec.yaml version: $PUBSPEC_VERSION (semantic: $PUBSPEC_VERSION_NUMBER)"

            - name: âœ… Validate version bump and match
              run: |
                  set -e
                  EXPECTED="${{ steps.version_info.outputs.VERSION_NUMBER }}"
                  PUBSPEC_VERSION_NUMBER="${{ steps.pubspec_version.outputs.PUBSPEC_VERSION_NUMBER }}"
                  echo "Expected version (from input/tag): $EXPECTED"
                  echo "pubspec.yaml version: $PUBSPEC_VERSION_NUMBER"
                  if [ "$PUBSPEC_VERSION_NUMBER" != "$EXPECTED" ]; then
                    echo "âŒ Version mismatch. Bump pubspec.yaml to $EXPECTED before running."
                    exit 1
                  fi
                  git fetch --tags --quiet
                  LAST_TAG=$(git tag --list 'v*.*.*' --sort=-v:refname | head -n1)
                  if [ -n "$LAST_TAG" ]; then
                    LAST="${LAST_TAG#v}"
                    if [ "$LAST" = "$EXPECTED" ]; then
                      echo "âš ï¸ Version $EXPECTED already exists as tag $LAST_TAG."
                      if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                        echo "â„¹ï¸ Manual dispatch - proceeding with existing tag"
                      else
                        echo "âŒ Automatic trigger - cannot create duplicate tag. Bump the version."
                        exit 1
                      fi
                    else
                      TOP=$(printf "%s\n%s" "$LAST" "$EXPECTED" | sort -V | tail -n1)
                      if [ "$TOP" != "$EXPECTED" ]; then
                        echo "âŒ Version $EXPECTED must be greater than last tag $LAST."
                        exit 1
                      fi
                    fi
                  fi
                  echo "âœ… Version validation passed."

            - name: â˜• Set up Java 17
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: ðŸ¦ Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.2"
                  channel: "stable"
                  cache: true

            - name: ðŸ”§ Configure Flutter
              run: |
                  flutter config --no-analytics
                  flutter config --no-cli-animations
                  export GRADLE_OPTS="-Xmx4g -XX:+UseG1GC"

            - name: ðŸ“¦ Install Dependencies
              run: |
                  flutter pub get
                  flutter pub deps
                  flutter doctor

            - name: ðŸ”§ Setup Firebase Configuration
              run: |
                  echo "Setting up Firebase configuration for CI build..."
                  if [ ! -f "android/app/google-services.json" ]; then
                    echo "Creating minimal google-services.json for CI build..."
                    cat > android/app/google-services.json << 'EOF'
                  {
                    "project_info": {
                      "project_number": "000000000000",
                      "project_id": "ci-build-project",
                      "storage_bucket": "ci-build-project.appspot.com"
                    },
                    "client": [
                      {
                        "client_info": {
                          "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                          "android_client_info": {
                            "package_name": "com.matrimpathak.attendence_flutter"
                          }
                        },
                        "oauth_client": [
                          {
                            "client_id": "000000000000-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com",
                            "client_type": 3
                          }
                        ],
                        "api_key": [
                          {
                            "current_key": "AIzaSyDummyKeyForCIBuild-XXXXXXXXXXXXXXX"
                          }
                        ],
                        "services": {
                          "appinvite_service": {
                            "other_platform_oauth_client": []
                          }
                        }
                      }
                    ],
                    "configuration_version": "1"
                  }
                  EOF
                    echo "âœ… Created minimal Firebase configuration for CI build"
                    echo "âš ï¸ Note: This is a template config - Firebase features will be limited"
                  else
                    echo "âœ… Firebase configuration file found"
                  fi

            - name: ðŸ§¹ Clean Build
              run: flutter clean

            - name: ðŸ”¨ Build Release APK
              run: |
                  echo "Building release APK..."
                  flutter build apk --release --dart-define=flutter.inspector.structuredErrors=false
                  echo "âœ… APK build completed"

            - name: ðŸ“± Build App Bundle (AAB)
              run: |
                  echo "Building release App Bundle..."
                  flutter build appbundle --release --dart-define=flutter.inspector.structuredErrors=false
                  echo "âœ… App Bundle build completed"

            - name: ðŸ“Š Get Build Info
              id: build_info
              run: |
                  APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
                  AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)

                  # Calculate version code from semantic version for display
                  VERSION="${{ steps.version_info.outputs.VERSION_NUMBER }}"
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
                  VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

                  echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
                  echo "AAB_SIZE=$AAB_SIZE" >> $GITHUB_OUTPUT
                  echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
                  echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

            - name: ðŸ“ Generate Release Notes
              id: release_notes
              run: |
                  cat > release_notes.md << EOF
                  ## ðŸŽ‰ OfficeLog ${{ steps.version_info.outputs.VERSION }}

                  **Built on:** ${{ steps.build_info.outputs.BUILD_DATE }}

                  ### ðŸ“± Download Options
                  - **APK**: ${{ steps.build_info.outputs.APK_SIZE }} - Direct install on Android devices
                  - **AAB**: ${{ steps.build_info.outputs.AAB_SIZE }} - For Google Play Store publishing

                  ### âœ¨ Features
                  - ðŸ‘¤ **AppBar Profile Picture**: Tap for profile management, long press for admin access
                  - ðŸ“ **Location-based Attendance**: Automatic check-in/check-out using geofencing
                  - ðŸ”„ **Persistent Auto Check-In**: Background service with WorkManager integration
                  - ðŸ”‹ **Battery Optimization**: Android battery optimization bypass system
                  - ðŸ“Š **Visual Analytics**: Beautiful charts showing attendance patterns
                  - ðŸ“… **Calendar Integration**: Monthly view with attendance tracking
                  - ðŸ”” **Smart Notifications**: Reminders for check-in/check-out
                  - ðŸŒ™ **Dark Mode**: Modern UI with light/dark theme support
                  - ðŸ” **Google Sign-In**: Secure authentication
                  - â˜ï¸ **Cloud Sync**: Data synchronized across devices
                  - ðŸ›¡ï¸ **Admin Panel**: Secure admin access with holiday and office management

                  ### ðŸ“² Installation Instructions
                  1. Download the APK file below
                  2. Enable "Install from unknown sources" in Android settings
                  3. Install the APK on your Android device
                  4. Grant location permissions when prompted
                  5. Sign in with your Google account

                  ### ðŸ“‹ System Requirements
                  - **Android**: 5.0+ (API level 21)
                  - **Permissions**: Location, Internet, Storage
                  - **Account**: Google account for authentication
                  - **Storage**: ~100MB free space

                  ### ðŸ”§ Technical Details
                  - **Package**: com.matrimpathak.attendence_flutter
                  - **Version Name**: ${{ steps.version_info.outputs.VERSION_NUMBER }}
                  - **Version Code**: ${{ steps.build_info.outputs.VERSION_CODE }} (auto-calculated)
                  - **Built from**: Commit ${{ github.sha }}
                  - **Target SDK**: Android 14 (API 34)
                  - **Minimum SDK**: Android 5.0 (API 21)
                  EOF

            - name: ðŸš€ Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version_info.outputs.VERSION }}
                  name: ðŸ¢ OfficeLog ${{ steps.version_info.outputs.VERSION }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: ${{ github.event.inputs.prerelease == 'true' }}
                  files: |
                      build/app/outputs/flutter-apk/app-release.apk
                      build/app/outputs/bundle/release/app-release.aab
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ðŸ“‹ Upload Build Artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: build-outputs-${{ steps.version_info.outputs.VERSION }}
                  path: |
                      build/app/outputs/flutter-apk/
                      build/app/outputs/bundle/
                  retention-days: 30
