name: ðŸš€ Build and Release OfficeLog

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    name: ðŸ“± Build APK & Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ðŸ¦ Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: |
        flutter pub get
        flutter pub deps

    - name: ðŸ”§ Update Firebase Configuration
      run: |
        echo "Updating google-services.json with Firebase configuration..."
        cat > android/app/google-services.json << EOF
        {
          "project_info": {
            "project_number": "${{ secrets.FIREBASE_PROJECT_NUMBER || '89886471430' }}",
            "project_id": "${{ secrets.FIREBASE_PROJECT_ID || 'pega-attendence' }}",
            "storage_bucket": "${{ secrets.FIREBASE_STORAGE_BUCKET || 'pega-attendence.firebasestorage.app' }}"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "${{ secrets.FIREBASE_ANDROID_APP_ID || '1:89886471430:android:0daf63b7dc13a70af75a87' }}",
                "android_client_info": {
                  "package_name": "${{ secrets.ANDROID_PACKAGE_NAME || 'com.matrimpathak.attendence_flutter' }}"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "${{ secrets.FIREBASE_ANDROID_API_KEY || 'AIzaSyDIRPwrWHZ5aVfU4WSEuUj7WtS237z5DO4' }}"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF
        echo "âœ… Firebase configuration updated"

    - name: ðŸ§¹ Clean Build
      run: flutter clean

    - name: ðŸ”¨ Build Release APK
      run: |
        echo "Building release APK..."
        flutter build apk --release --verbose
        echo "âœ… APK build completed"

    - name: ðŸ“± Build App Bundle (AAB)
      run: |
        echo "Building release App Bundle..."
        flutter build appbundle --release --verbose
        echo "âœ… App Bundle build completed"

    - name: ðŸ“Š Get Build Info
      id: build_info
      run: |
        APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
        AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "AAB_SIZE=$AAB_SIZE" >> $GITHUB_OUTPUT
        echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: ðŸ·ï¸ Get Version Info
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ Release version: $VERSION"

    - name: ðŸ“ Generate Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        ## ðŸŽ‰ OfficeLog ${{ steps.get_version.outputs.VERSION }}
        
        **Built on:** ${{ steps.build_info.outputs.BUILD_DATE }}
        
        ### ðŸ“± Download Options
        - **APK**: ${{ steps.build_info.outputs.APK_SIZE }} - Direct install on Android devices
        - **AAB**: ${{ steps.build_info.outputs.AAB_SIZE }} - For Google Play Store publishing
        
        ### âœ¨ Features
        - ðŸ“ **Location-based Attendance**: Automatic check-in/check-out using geofencing
        - ðŸ“Š **Visual Analytics**: Beautiful charts showing attendance patterns
        - ðŸ“… **Calendar Integration**: Monthly view with attendance tracking
        - ðŸ”” **Smart Notifications**: Reminders for check-in/check-out
        - ðŸŒ™ **Dark Mode**: Modern UI with light/dark theme support
        - ðŸ” **Google Sign-In**: Secure authentication
        - â˜ï¸ **Cloud Sync**: Data synchronized across devices
        
        ### ðŸ“² Installation Instructions
        1. Download the APK file below
        2. Enable "Install from unknown sources" in Android settings
        3. Install the APK on your Android device
        4. Grant location permissions when prompted
        5. Sign in with your Google account
        
        ### ðŸ“‹ System Requirements
        - **Android**: 5.0+ (API level 21)
        - **Permissions**: Location, Internet, Storage
        - **Account**: Google account for authentication
        - **Storage**: ~100MB free space
        
        ### ðŸ”§ Technical Details
        - **Package**: com.matrimpathak.attendence_flutter
        - **Version Code**: Built from commit ${{ github.sha }}
        - **Target SDK**: Android 14 (API 34)
        - **Minimum SDK**: Android 5.0 (API 21)
        EOF

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: ðŸ¢ OfficeLog ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“‹ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-outputs-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/app/outputs/flutter-apk/
          build/app/outputs/bundle/
        retention-days: 30
